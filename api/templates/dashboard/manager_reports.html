<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Report Management</h3>
                <div class="card-tools">
                    <button class="btn btn-primary" data-toggle="modal" data-target="#createReportModal">
                        <i class="fas fa-plus"></i> Create New Report
                    </button>
                </div>
            </div>
            <div class="card-body">
                <table class="table table-bordered table-striped datatable">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>County</th>
                            <th>Sublocation</th>
                            <th>Assigned To</th>
                            <th>Status</th>
                            <th>Entries</th>
                            <th>Active Rate</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        <!-- Reports will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Create Report Modal -->
<div class="modal fade" id="createReportModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Report</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="createReportForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="reportTitle">Report Title</label>
                                <input type="text" class="form-control" id="reportTitle" name="title" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="reportStatus">Status</label>
                                <select class="form-control" id="reportStatus" name="status" required>
                                    <option value="pending">Pending</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportDescription">Description</label>
                        <textarea class="form-control" id="reportDescription" name="description" rows="3" required></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="reportCounty">County</label>
                                <select class="form-control select2" id="reportCounty" name="county" required>
                                    <option value="">Select County</option>
                                    {% for county_value, county_name in county_choices %}
                                        <option value="{{ county_value }}">{{ county_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="reportSublocation">Sublocation</label>
                                <select class="form-control select2" id="reportSublocation" name="sublocation" required>
                                    <option value="">Select Sublocation</option>
                                    {% for sub_value, sub_name in sublocation_choices %}
                                        <option value="{{ sub_value }}">{{ sub_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportAssignedTo">Assign To</label>
                        <select class="form-control select2" id="reportAssignedTo" name="assigned_to" required>
                            <option value="">Select User</option>
                            <!-- Users will be loaded dynamically -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportFeedback">Manager Feedback (Optional)</label>
                        <textarea class="form-control" id="reportFeedback" name="manager_feedback" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Report</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    loadReports();
    loadUsersForAssignment();
    
    // Handle report creation
    $('#createReportForm').on('submit', function(e) {
        e.preventDefault();
        createReport();
    });
    
    function loadReports() {
        $.ajax({
            url: '/api/reports/',
            type: 'GET',
            success: function(response) {
                updateReportsTable(response);
            },
            error: function(xhr) {
                console.error('Error loading reports:', xhr);
                showAlert('Error loading reports', 'danger');
            }
        });
    }
    
    function loadUsersForAssignment() {
        $.ajax({
            url: '/api/users/',
            type: 'GET',
            success: function(response) {
                const select = $('#reportAssignedTo');
                select.empty().append('<option value="">Select User</option>');
                
                response.forEach(user => {
                    if (user.role !== 'manager') {
                        select.append(`<option value="${user.id}">${user.employee_id} - ${user.first_name} ${user.last_name} (${user.role})</option>`);
                    }
                });
            }
        });
    }
    
    function createReport() {
        const formData = new FormData($('#createReportForm')[0]);
        
        $.ajax({
            url: '/api/reports/',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                showAlert('Report created successfully!', 'success');
                $('#createReportModal').modal('hide');
                $('#createReportForm')[0].reset();
                $('.select2').val(null).trigger('change');
                loadReports();
            },
            error: function(xhr) {
                const errors = xhr.responseJSON;
                let errorMessage = 'Error creating report';
                if (errors) {
                    errorMessage = Object.values(errors).flat().join(', ');
                }
                showAlert(errorMessage, 'danger');
            }
        });
    }
    
    function updateReportsTable(reports) {
        const tbody = $('#reportsTableBody');
        tbody.empty();
        
        reports.forEach(report => {
            const statusBadge = getStatusBadge(report.status);
            const actions = `
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-info" onclick="viewReport(${report.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-warning" onclick="editReport(${report.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-success" onclick="manageReportData(${report.id})">
                        <i class="fas fa-database"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteReport(${report.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            tbody.append(`
                <tr>
                    <td>${report.title}</td>
                    <td>${report.county}</td>
                    <td>${report.sublocation}</td>
                    <td>${report.assigned_to_name || 'Unassigned'}</td>
                    <td><span class="badge ${statusBadge}">${report.status}</span></td>
                    <td>${report.total_entries}</td>
                    <td>${report.active_rate}%</td>
                    <td>${new Date(report.created_at).toLocaleDateString()}</td>
                    <td>${actions}</td>
                </tr>
            `);
        });
    }
    
    function getStatusBadge(status) {
        const statusMap = {
            'completed': 'badge-success',
            'pending': 'badge-warning',
            'in_progress': 'badge-info'
        };
        return statusMap[status] || 'badge-secondary';
    }
});

// Global functions for report actions
function viewReport(reportId) {
    window.location.href = `/api/reports/${reportId}/`;
}

function editReport(reportId) {
    // Implement edit functionality
    alert('Edit report: ' + reportId);
}

function manageReportData(reportId) {
    // Switch to data entries tab and filter by report
    $('.nav-link[href="#entries"]').tab('show');
    // You can implement filtering logic here
    alert('Manage data for report: ' + reportId);
}

function deleteReport(reportId) {
    if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
        $.ajax({
            url: `/api/reports/${reportId}/`,
            type: 'DELETE',
            headers: {
                'X-CSRFToken': getCSRFToken()
            },
            success: function(response) {
                showAlert('Report deleted successfully', 'success');
                loadReports();
            },
            error: function(xhr) {
                showAlert('Error deleting report', 'danger');
            }
        });
    }
}
</script>